## 1. 定义核函数

CUDA 程序使用限定词 **\_\_global\_\_** 来标识在主机上调用并且运行在 GPU 函数，称为核函数。核函数的返回值必须为 void。限定词 **\_\_global\_\_** 和 void 的顺序可以调换。核函数的参数不受限。限定词可以和其他的 C++ 修饰词比如 static 一起使用，并且顺序任意。

```c++
__global__ void hello_world_gpu() {
    printf("hello cuda\n");
}
```

CUDA 中核函数支持重载，但是不支持可变参数列表。可以向核函数传递非指针变量，传入的内容对每个线程可见。核函数不能是一个类成员。
另外，不同于 **\_\_global\_\_** ，另外有 **\_\_device\_\_** 修饰的设备函数在设备中执行，但是不能被主机函数调用，只能被 **\_\_global\_\_** 修饰的核函数，或者其他设备函数调用。不能同时将一个函数设置为 **\_\_global\_\_** 和 **\_\_device\_\_**。

实际上 CUDA 还有 **\_\_host\_\_** 限定词来标识在主机端运行的函数，可以省略。对于 **\_\_global\_\_** 和 **\_\_device\_\_** 函数内部，不推荐使用递归，少用 malloc，不要用静态变量。

## 2. 调用核函数

上述的核函数的调用格式可以见如下示例代码。

```c++
int grid_size = 3, block_size = 4;
hello_world_gpu<<<grid_size, block_size>>>();

dim3 grid_dim(3,3);
dim3 block_dim(4,4);
hello_world_gpu<<<grid_dim, block_dim>>>();
```

其中 grid_size 和 block_size 分别表示网格大小和线程块大小，是个整型变量。此外代码中表面也可以利用 dim3 的结构体来定义多维的网格和线程块的维度。结构体 dim3 包含了 x, y, z 三个成员变量，分别可以指定 1 维， 2 维， 3 维的网格或者线程块。如果 grid_size 和 block_size 为标量，那么对应的网格和线程块为 1 维。

需要澄清的是：
+ grid_size: 网格由多个线程块组成，这里 grid_size 表示网格中线程块的组织形式。
+ block_size: 一个线程块由多个线程组成，block_size 表示线程块中线程的组织形式。

## 3. 线程索引

每一个线程块，线程块中的每一个线程在核函数中都有唯一的身份标识。假设**线程块**以 3 维的形式组织，那么每一个**线程块**可以由三个参数 (gx, gy, gz) 标识。对应的标识获取具体如下：

1. 使用 gridDims.x, gridDims.y, gridDims.z 获取网格的 x, y, z 维度上的线程块数量，这个就是调用核函数时定义的对应维度 grid_size 值；
2. 使用 blockIdx.x, blockIdx.y, blockIdx.z 获取当前线程块在三维网格中的索引 (bx, by, bz)，gx 的范围为 $0 < bx < x-1$。

同样的，对于 3 维线程块，线程块中的每一个线程也有唯一的三个参数 (tx, ty, tz) 标识。对应的标识获取具体如下：

1. 使用 blockDim.x, blockDim.y, blockDim.z 获取线程块 x, y, z维度上的线程块数量，这个也是调用核函数时定义的对应维度的 block_size 的值；
2. 使用 threadIdx.x, threadIdx.y, threadIdx.z 获取当前线程在三位线程块中的索引 (tx, ty, tz)，tx 的范围为 $0 < tx < x-1$。

结合网格中线程块的标识和线程块中线程的标识，可以确定网格中线程的标识。需要说明的是，多维的网格、线程块本质上还是一维的。并且在维度上 x 是最内层的，即变化最快，而 z 是最外围，变换最慢。在一些场景下，利用线程索引访问对应的数组元素时需要注意数组的越界问题。


## 4. 网格与线程块大小限制

对于网格尺寸(grid_soze)，x 的最大值为 2^31-1，y 和 z 的最大值为 65535，对于线程块，x，y 两个维度的最大值为 1024，z 维度的最大值为 65，并且 x, y, z 三者的乘积需要小于 1024。



